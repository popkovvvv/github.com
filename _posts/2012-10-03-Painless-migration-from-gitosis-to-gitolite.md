---
layout: post
title: "Painless migration from gitosis to gitolite"
category : Programming
---

Gitosis уже не поддерживается, и не за горами стабильный релиз Debian Wheezy, на котором его уже не будет. Поэтому было принято решение о миграции на gitolite. Не смотря на то, что есть соответствующий мануал [http://sitaramc.github.com/gitolite/gsmigr.html](http://sitaramc.github.com/gitolite/gsmigr.html), он не даёт ответа на вопрос - "Как сделать это безболезненно?". Об этом сейчас и пойдёт речь.

Идея состоит в следующем: поднять на этом же пользователе gitolite, проверить его работу и с минимальным downtime заменить gitosis на gitolite. 

Поскольку установка ведётся на одном пользователе, то возможны конфликты. Поэтому было выяснено, что при дефолтных конфигурациях возможен конфликт между папкой, в которой хранятся репозитории `~/repositories` и файлом `~/.ssh/authorized_keys`, который автоматически генерируется этими приложениями. В первом случае есть возможность изменить дефолтный путь, а вот для второго случая, автор gitolite не предусмотрел такой возможности. Хоть там и perl, не беда --- прорвёмся. Небольшой коммит исправил положение [https://github.com/f0y/gitolite.git](https://github.com/f0y/gitolite.git). Установку будем производить из исходников, поскольку это даёт больше гибкости. Алтернативный способ - пересобрать пакет, но тогда теряется преимущество связанное с простым обновлением пакета. Так что первый вариант предпочтительней.

Я не буду расписывать полную установку, так как она уже есть на [http://sitaramc.github.com/gitolite/install.html](http://sitaramc.github.com/gitolite/install.html), а опишу только специфичные моменты. Перед выполнением gitolite setup необходимо изменить в файле `src/lib/Gitolite/Rc.pm` параметры `GL_REPO_BASE` и `SSH_AUTH_KEY`. К примеру заменим `authorized_keys` на `authorized_keys_gitolite`, а в `GL_REPO_BASE` укажем другую папку. Теперь можно смело продолжать установку, поскольку конфликты исключены.

Gitolite и gitosis не могут одновременно использовать один экземпляр ssh, поэтому поднимем второй. Для этого нужно скопировать конфиг по адресу `/etc/ssh/sshd_config` скажем в `/etc/ssh/sshd_config_gitolite` и изменить последний: раскомментировать поле `AuthorizedKeysFile` и прописать в нём тот файл, который был указан ранее в конфиге gitolite (`authorized_keys_gitolite`). Также необходимо изменить параметр `Port` на другой, пусть это будет `22222`. Теперь запускаем ssh в debug режиме `sudo /usr/sbin/sshd -ddd -f /etc/ssh/sshd_config_gitolite` и клонируем репозиторий `git clone ssh://git@git-server:22222/testing`. Проверяем всё ли верно работает и переходим к той миграции, которая описана в мануале gitolite: добавляем ключи и настраиваем конфиг, репозитории пока не трогаем.

Последний шаг заключается в том, чтобы переключиться на gitolite. Для этого отрубаем доступ всем к git (чтобы не поступало новых изменений) переместив файл `.ssh/authorized_keys` в другое место. Далее копируем репозитории из `~/repositories` в `~/repo` и запускаем `gitolite setup` (можно и симлинки, но не проверял). Последним действием заменяем `SSH_AUTH_KEY` на дефолтное значение и также переименовываем файл `authorized_keys_gitolite` в `authorized_keys`. Таким образом миграция успешно завершена. 

Что в итоге: способ является достаточно безболезненным, потому что установка gitolite производится независимо, а время downtime равняется времени копирования репозиториев, что для большинства случаев приемлимо. Более того, downtime можно уменьшить использовав симлинки.

Удачной миграции!

